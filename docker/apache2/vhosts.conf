# Frontend Virtual Host - atonixcorp.com
<VirtualHost *:80>
    ServerName atonixcorp.com
    ServerAlias www.atonixcorp.com
    ServerAdmin admin@atonixcorp.com

    # Proxy to frontend container on port 3001
    ProxyPreserveHost On
    ProxyRequests Off

    <Proxy *>
        Require all granted
    </Proxy>

    # Rewrite rules for frontend
    <IfModule mod_rewrite.c>
        RewriteEngine On
        
        # Don't rewrite if it's a real file or directory
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        
        # Rewrite all requests to /api/* to the backend
        RewriteCond %{REQUEST_URI} ^/api
        RewriteRule ^/api/(.*)$ http://api.atonixcorp.com/api/$1 [P,L]
        
        # Otherwise proxy to frontend
        RewriteRule ^(.*)$ http://atonixcorp_frontend:80$1 [P,L]
    </IfModule>

    # ProxyPass and ProxyPassReverse for API calls
    ProxyPass /api http://atonixcorp_backend:8000/api
    ProxyPassReverse /api http://atonixcorp_backend:8000/api
    
    # Proxy main frontend
    ProxyPass / http://atonixcorp_frontend:80/
    ProxyPassReverse / http://atonixcorp_frontend:80/

    # Headers
    RequestHeader set X-Forwarded-Proto "http"
    RequestHeader set X-Forwarded-Host "atonixcorp.com"
    RequestHeader set X-Real-IP "%{REMOTE_ADDR}s"

    # Logging
    ErrorLog /proc/self/fd/2
    CustomLog /proc/self/fd/1 "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\""

    # Security headers
    Header set X-Frame-Options "SAMEORIGIN"
    Header set X-Content-Type-Options "nosniff"
    Header set X-XSS-Protection "1; mode=block"
</VirtualHost>

# Backend API Virtual Host - api.atonixcorp.com
<VirtualHost *:80>
    ServerName api.atonixcorp.com
    ServerAlias www.api.atonixcorp.com
    ServerAdmin admin@atonixcorp.com

    # Proxy to backend container on port 8000
    ProxyPreserveHost On
    ProxyRequests Off

    <Proxy *>
        Require all granted
    </Proxy>

    # Proxy all requests to Django backend
    ProxyPass / http://atonixcorp_backend:8000/
    ProxyPassReverse / http://atonixcorp_backend:8000/

    # Headers for API
    RequestHeader set X-Forwarded-Proto "http"
    RequestHeader set X-Forwarded-Host "api.atonixcorp.com"
    RequestHeader set X-Real-IP "%{REMOTE_ADDR}s"

    # CORS headers for API
    Header set Access-Control-Allow-Origin "*"
    Header set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS, PATCH"
    Header set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"

    # Handle OPTIONS requests (preflight requests)
    <If "%{REQUEST_METHOD} == 'OPTIONS'">
        Require all granted
    </If>

    # Logging
    ErrorLog /proc/self/fd/2
    CustomLog /proc/self/fd/1 "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\""

    # Security headers
    Header set X-Frame-Options "SAMEORIGIN"
    Header set X-Content-Type-Options "nosniff"
    Header set X-XSS-Protection "1; mode=block"
</VirtualHost>
