# Frontend Virtual Host - atonixcorp.org (HTTPS)
<VirtualHost *:443>
    ServerName atonixcorp.org
    ServerAlias www.atonixcorp.org
    ServerAdmin admin@atonixcorp.org

    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/apache2/certs/atonixcorp.org.crt
    SSLCertificateKeyFile /etc/apache2/certs/atonixcorp.org.key
    SSLCertificateChainFile /etc/apache2/certs/chain.crt

    # SSL Protocol and Ciphers
    SSLProtocol all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384

    # Proxy to frontend container
    ProxyPreserveHost On
    ProxyRequests Off

    <Proxy *>
        Require all granted
    </Proxy>

    # Rewrite rules for frontend
    <IfModule mod_rewrite.c>
        RewriteEngine On
        
        # Don't rewrite if it's a real file or directory
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        
        # Rewrite all requests to /api/* to the backend
        RewriteCond %{REQUEST_URI} ^/api
        RewriteRule ^/api/(.*)$ https://api.atonixcorp.org/api/$1 [P,L]
        
        # Otherwise proxy to frontend
        RewriteRule ^(.*)$ http://atonixcorp_frontend:80$1 [P,L]
    </IfModule>

    # ProxyPass and ProxyPassReverse for API calls
    ProxyPass /api http://atonixcorp_backend:8000/api
    ProxyPassReverse /api http://atonixcorp_backend:8000/api
    
    # Proxy main frontend
    ProxyPass / http://atonixcorp_frontend:80/
    ProxyPassReverse / http://atonixcorp_frontend:80/

    # Headers
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Host "atonixcorp.org"
    RequestHeader set X-Real-IP "%{REMOTE_ADDR}s"

    # Logging
    ErrorLog /proc/self/fd/2
    CustomLog /proc/self/fd/1 "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\""

    # Security headers
    Header set X-Frame-Options "SAMEORIGIN"
    Header set X-Content-Type-Options "nosniff"
    Header set X-XSS-Protection "1; mode=block"
    Header set Strict-Transport-Security "max-age=31536000; includeSubDomains"
</VirtualHost>

# Backend API Virtual Host - api.atonixcorp.org (HTTPS)
<VirtualHost *:443>
    ServerName api.atonixcorp.org
    ServerAlias www.api.atonixcorp.org
    ServerAdmin admin@atonixcorp.org

    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/apache2/certs/api.atonixcorp.org.crt
    SSLCertificateKeyFile /etc/apache2/certs/api.atonixcorp.org.key
    SSLCertificateChainFile /etc/apache2/certs/chain.crt

    # SSL Protocol and Ciphers
    SSLProtocol all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384

    # Proxy to backend container
    ProxyPreserveHost On
    ProxyRequests Off

    <Proxy *>
        Require all granted
    </Proxy>

    # Proxy all requests to Django backend
    ProxyPass / http://atonixcorp_backend:8000/
    ProxyPassReverse / http://atonixcorp_backend:8000/

    # Headers for API
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Host "api.atonixcorp.org"
    RequestHeader set X-Real-IP "%{REMOTE_ADDR}s"

    # CORS headers for API
    Header set Access-Control-Allow-Origin "*"
    Header set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS, PATCH"
    Header set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"

    # Allow OPTIONS requests without authentication
    <Limit OPTIONS>
        Require all granted
    </Limit>

    # Logging
    ErrorLog /proc/self/fd/2
    CustomLog /proc/self/fd/1 "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\""

    # Security headers
    Header set X-Frame-Options "SAMEORIGIN"
    Header set X-Content-Type-Options "nosniff"
    Header set X-XSS-Protection "1; mode=block"
    Header set Strict-Transport-Security "max-age=31536000; includeSubDomains"
</VirtualHost>

# HTTP to HTTPS Redirect
<VirtualHost *:80>
    ServerName atonixcorp.org
    ServerAlias www.atonixcorp.org api.atonixcorp.org www.api.atonixcorp.org
    
    <IfModule mod_rewrite.c>
        RewriteEngine On
        RewriteCond %{HTTPS} off
        RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
    </IfModule>
</VirtualHost>
