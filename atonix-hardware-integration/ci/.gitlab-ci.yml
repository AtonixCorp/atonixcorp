# AtonixCorp Hardware Integration CI/CD Pipelinestages:

# GitLab CI/CD configuration for hardware security and integration testing  - build

  - test

stages:  - deploy

  - validate  - security

  - build  - firmware

  - test

  - deployvariables:

  - security  GO_VERSION: "1.21"

  SGX_SDK_VERSION: "2.19.100.3"

variables:  AMD_SEV_TOOL_VERSION: "latest"

  DOCKER_DRIVER: overlay2  TPM2_TOOLS_VERSION: "5.5"

  DOCKER_TLS_CERTDIR: "/certs"  OPTEE_VERSION: "4.0.0"

  YOCTO_VERSION: "kirkstone"  ARM_TF_VERSION: "v2.9"

  BUILDKIT_PROGRESS: plain

build:

# Template for hardware test jobs  stage: build

.hardware_test_template: &hardware_test_template  image: golang:${GO_VERSION}

  image: registry.atonixcorp.org/hardware-integration/ci:latest  script:

  services:    - go mod tidy

    - docker:dind    - go build -o hardware-agent ./src/agent/main.go

  variables:  artifacts:

    DOCKER_HOST: tcp://docker:2376    paths:

    DOCKER_TLS_VERIFY: 1      - hardware-agent

    DOCKER_CERT_PATH: "$DOCKER_TLS_CERTDIR/client"

  before_script:test:

    - docker info  stage: test

    - apt-get update && apt-get install -y git-lfs qemu-user-static binfmt-support  image: golang:${GO_VERSION}

    - git lfs pull  script:

  cache:    - go test ./src/...

    key: ${CI_COMMIT_REF_SLUG}

    paths:yocto:

      - yocto/downloads/  stage: build

      - yocto/sstate-cache/  image: ubuntu:22.04

  artifacts:  script:

    reports:    - apt-get update && apt-get install -y build-essential git python3 wget

      junit: reports/*.xml    - cd yocto

    paths:    - ./setup-yocto.sh

      - yocto/build-*/tmp/deploy/images/    - ./build-image.sh

    expire_in: 1 week  artifacts:

    paths:

# Validate Yocto configuration      - yocto/tmp/deploy/images/

validate:yocto:

  <<: *hardware_test_templateplatformio:

  stage: validate  stage: build

  script:  image: python:3.11

    - cd yocto  script:

    - ./validate-yocto-config.sh    - pip install platformio

  only:    - cd platformio

    - merge_requests    - platformio run

    - main  artifacts:

    - develop    paths:

      - platformio/.pio/build/*/firmware.*

# Build Yocto images

build:yocto:sgx:

  <<: *hardware_test_template  stage: security

  stage: build  image: ubuntu:22.04

  script:  script:

    - cd yocto    - apt-get update && apt-get install -y wget build-essential python3

    - ./build-yocto.sh    - wget https://download.01.org/intel-sgx/sgx-linux/${SGX_SDK_VERSION}/sgx_linux_x64_sdk_${SGX_SDK_VERSION}.bin

  parallel:    - chmod +x sgx_linux_x64_sdk_${SGX_SDK_VERSION}.bin

    matrix:    - ./sgx_linux_x64_sdk_${SGX_SDK_VERSION}.bin --prefix=/opt/intel/sgx-sdk

      - MACHINE: [qemuarm64, raspberrypi4-64, intel-corei7-64]    - echo "SGX SDK installed"

  artifacts:  artifacts:

    paths:    paths:

      - yocto/build-*/tmp/deploy/images/      - /opt/intel/sgx-sdk

      - yocto/build-*/tmp/deploy/sdk/

    expire_in: 1 monthamd-sev:

  only:  stage: security

    - main  image: ubuntu:22.04

    - develop  script:

    - apt-get update && apt-get install -y git make gcc

# Hardware security tests    - git clone https://github.com/AMDESE/AMDSEV-Tool.git

test:hardware_security:    - cd AMDSEV-Tool && make

  <<: *hardware_test_template    - echo "AMD SEV Tool built"

  stage: test  artifacts:

  script:    paths:

    - cd tests/hardware-security      - AMDSEV-Tool

    - ./run-hardware-tests.sh

  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'tpm2-tools:

  artifacts:  stage: security

    reports:  image: ubuntu:22.04

      coverage_report:  script:

        coverage_format: cobertura    - apt-get update && apt-get install -y tpm2-tools=${TPM2_TOOLS_VERSION} tpm2-tss

        path: coverage/coverage.xml    - tpm2_getrandom 4

      junit: reports/hardware-tests.xml    - echo "TPM2 tools tested"

  dependencies:

    - build:yoctooptee:

  stage: firmware

# TPM integration tests  image: ubuntu:22.04

test:tpm:  script:

  <<: *hardware_test_template    - apt-get update && apt-get install -y git make gcc python3

  stage: test    - git clone https://github.com/OP-TEE/optee_os.git -b ${OPTEE_VERSION}

  script:    - cd optee_os && make

    - cd tests/tpm    - echo "OP-TEE firmware built"

    - ./test-tpm-integration.sh  artifacts:

  artifacts:    paths:

    reports:      - optee_os

      junit: reports/tpm-tests.xml

  dependencies:arm-trusted-firmware:

    - build:yocto  stage: firmware

  image: ubuntu:22.04

# SGX integration tests  script:

test:sgx:    - apt-get update && apt-get install -y git make gcc python3

  <<: *hardware_test_template    - git clone https://github.com/ARM-software/arm-trusted-firmware.git -b ${ARM_TF_VERSION}

  stage: test    - cd arm-trusted-firmware && make PLAT=arm64

  script:    - echo "Arm Trusted Firmware built"

    - cd tests/sgx  artifacts:

    - ./test-sgx-integration.sh    paths:

  artifacts:      - arm-trusted-firmware

    reports:

      junit: reports/sgx-tests.xmldeploy:

  dependencies:  stage: deploy

    - build:yocto  image: docker:latest

  script:

# SEV integration tests    - echo "Deploy step placeholder"

test:sev:
  <<: *hardware_test_template
  stage: test
  script:
    - cd tests/sev
    - ./test-sev-integration.sh
  artifacts:
    reports:
      junit: reports/sev-tests.xml
  dependencies:
    - build:yocto

# OP-TEE integration tests
test:optee:
  <<: *hardware_test_template
  stage: test
  script:
    - cd tests/optee
    - ./test-optee-integration.sh
  artifacts:
    reports:
      junit: reports/optee-tests.xml
  dependencies:
    - build:yocto

# TrustZone integration tests
test:trustzone:
  <<: *hardware_test_template
  stage: test
  script:
    - cd tests/trustzone
    - ./test-trustzone-integration.sh
  artifacts:
    reports:
      junit: reports/trustzone-tests.xml
  dependencies:
    - build:yocto

# Firmware update tests
test:firmware:
  <<: *hardware_test_template
  stage: test
  script:
    - cd tests/firmware
    - ./test-firmware-update.sh
  artifacts:
    reports:
      junit: reports/firmware-tests.xml
  dependencies:
    - build:yocto

# Security audit
security:audit:
  image: registry.atonixcorp.org/security/audit:latest
  stage: security
  script:
    - ./security/audit-hardware.sh
  artifacts:
    reports:
      sast: gl-sast-report.json
    paths:
      - security/reports/
    expire_in: 1 month
  only:
    - main
    - develop

# Deploy to staging
deploy:staging:
  stage: deploy
  script:
    - ./deploy/deploy-staging.sh
  environment:
    name: staging
    url: https://staging-hardware.atonixcorp.org
  dependencies:
    - build:yocto
  only:
    - develop

# Deploy to production
deploy:production:
  stage: deploy
  script:
    - ./deploy/deploy-production.sh
  environment:
    name: production
    url: https://hardware.atonixcorp.org
  dependencies:
    - build:yocto
    - test:hardware_security
    - test:tpm
    - test:sgx
    - test:sev
    - test:optee
    - test:trustzone
    - test:firmware
    - security:audit
  only:
    - main
  when: manual

# Performance monitoring
performance:monitor:
  image: registry.atonixcorp.org/monitoring/performance:latest
  stage: deploy
  script:
    - ./monitoring/run-performance-tests.sh
  artifacts:
    reports:
      performance: performance-report.json
    paths:
      - monitoring/reports/
  dependencies:
    - deploy:staging
  only:
    - main
    - develop

# Cleanup job
cleanup:
  stage: .post
  script:
    - docker system prune -f
    - rm -rf yocto/build-*/tmp/work/
  when: always
