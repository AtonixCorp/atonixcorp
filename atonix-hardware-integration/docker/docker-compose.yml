# AtonixCorp Hardware Integration Development Environment
version: '3.8'

services:
  hardware-ci:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: atonix-hardware-ci
    volumes:
      - ..:/workspace
      - /var/run/docker.sock:/var/run/docker.sock
    working_dir: /workspace
    environment:
      - DOCKER_HOST=unix:///var/run/docker.sock
      - YOCTO_DOWNLOAD_DIR=/workspace/yocto/downloads
      - YOCTO_SSTATE_DIR=/workspace/yocto/sstate-cache
    command: sleep infinity

  yocto-builder:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: atonix-yocto-builder
    volumes:
      - ..:/workspace
      - yocto_downloads:/workspace/yocto/downloads
      - yocto_sstate:/workspace/yocto/sstate-cache
    working_dir: /workspace
    environment:
      - YOCTO_VERSION=kirkstone
      - MACHINE=qemuarm64
    command: sleep infinity

  hardware-tester:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: atonix-hardware-tester
    volumes:
      - ..:/workspace
      - ./reports:/workspace/reports
      - ./coverage:/workspace/coverage
    working_dir: /workspace
    environment:
      - TEST_RESULTS_DIR=/workspace/reports
      - COVERAGE_DIR=/workspace/coverage
    command: sleep infinity

  tpm-simulator:
    image: tpm2-software/tpm2-simulator:latest
    container_name: atonix-tpm-simulator
    ports:
      - "2321:2321"
      - "2322:2322"
    command: tpm2-simulator

  sgx-simulator:
    image: intel/sgx-simulator:latest
    container_name: atonix-sgx-simulator
    privileged: true
    devices:
      - /dev/sgx_enclave
      - /dev/sgx_provision
    volumes:
      - /dev:/dev
    command: sgx-simulator

  optee-simulator:
    image: linaro/optee-simulator:latest
    container_name: atonix-optee-simulator
    privileged: true
    ports:
      - "1234:1234"
    command: qemu-system-arm -s -S -machine virt -cpu cortex-a15 -m 1024 -kernel Image -initrd rootfs.cpio.gz -append "console=ttyAMA0" -nographic

volumes:
  yocto_downloads:
    driver: local
  yocto_sstate:
    driver: local

networks:
  default:
    name: atonix-hardware-network
