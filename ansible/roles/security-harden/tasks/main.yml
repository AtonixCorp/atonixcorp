---
# security-harden role â€” CIS benchmark hardening for all AtonixCorp VMs

- name: Disable root SSH login
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?PermitRootLogin'
    line: 'PermitRootLogin no'
  notify: restart sshd

- name: Disable password authentication (SSH key only)
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?PasswordAuthentication'
    line: 'PasswordAuthentication no'
  notify: restart sshd

- name: Set SSH idle timeout
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?ClientAliveInterval'
    line: 'ClientAliveInterval 300'
  notify: restart sshd

- name: Enable UFW firewall
  community.general.ufw:
    state: enabled
    policy: deny

- name: Allow SSH
  community.general.ufw:
    rule: allow
    port: "22"
    proto: tcp

- name: Allow Prometheus node_exporter scrape
  community.general.ufw:
    rule: allow
    port: "9100"
    proto: tcp
    src: "10.0.0.0/8"

- name: Set sysctl hardening
  ansible.posix.sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    sysctl_set: true
    reload: true
  loop:
    - { name: "kernel.dmesg_restrict", value: "1" }
    - { name: "kernel.kptr_restrict", value: "2" }
    - { name: "net.ipv4.conf.all.accept_redirects", value: "0" }
    - { name: "net.ipv4.conf.all.send_redirects", value: "0" }
    - { name: "net.ipv4.conf.default.rp_filter", value: "1" }
    - { name: "net.ipv4.tcp_syncookies", value: "1" }

- name: Disable unused kernel modules
  ansible.builtin.lineinfile:
    path: /etc/modprobe.d/blacklist-atonix.conf
    line: "blacklist {{ item }}"
    create: true
    mode: "0644"
  loop:
    - usb-storage
    - cramfs
    - freevxfs
    - hfs
    - hfsplus

handlers:
  - name: restart sshd
    ansible.builtin.service:
      name: sshd
      state: restarted
