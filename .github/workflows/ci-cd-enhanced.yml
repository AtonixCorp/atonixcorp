name: AtonixCorp CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  REGISTRY: docker.io
  IMAGE_REPO_FRONTEND: atonixdev/atonixcorp-frontend
  IMAGE_REPO_BACKEND: atonixdev/atonixcorp-backend
  REGISTRY_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  REGISTRY_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

jobs:
  # Stage 1: Code Quality & Linting
  lint-and-format:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Lint Python (Backend)
        run: |
          pip install pylint flake8
          flake8 backend --max-line-length=120 --ignore=E501,W503 || true
          pylint backend --disable=all --enable=E,F || true
      
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
      
      - name: Lint JavaScript (Frontend)
        working-directory: frontend
        run: |
          npm ci --legacy-peer-deps
          npm run lint || true

  # Stage 2: Unit Tests
  unit-tests-backend:
    name: Backend Unit Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
          pip install pytest pytest-cov pytest-django
      
      - name: Run unit tests with coverage
        env:
          DATABASE_URL: postgres://test_user:test_password@localhost:5432/test_db
          REDIS_URL: redis://localhost:6379
        run: |
          cd backend
          pytest tests/unit/ -v --cov=. --cov-report=xml || true
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./backend/coverage.xml
          flags: backend
          fail_ci_if_error: false

  unit-tests-frontend:
    name: Frontend Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
      
      - name: Cache Node dependencies
        uses: actions/cache@v3
        with:
          path: frontend/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      
      - name: Install dependencies
        working-directory: frontend
        run: npm ci --legacy-peer-deps
      
      - name: Run tests with coverage
        working-directory: frontend
        run: npm test -- --watchAll=false --coverage || true
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./frontend/coverage/lcov.info
          flags: frontend
          fail_ci_if_error: false

  # Stage 3: Security Scanning
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
      
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: 'trivy-results.sarif'
      
      - name: Check Python dependencies
        run: |
          pip install safety
          safety check --json || true
      
      - name: OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'AtonixCorp'
          path: '.'
          format: 'JSON'
          args: >
            --enableExperimental

  # Stage 4: Build Docker Images
  build-containers:
    name: Build & Push Containers
    runs-on: ubuntu-latest
    needs: [lint-and-format, unit-tests-backend, unit-tests-frontend, security-scan]
    if: github.event_name == 'push'
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Log in to Docker Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ env.REGISTRY_USERNAME }}
          password: ${{ env.REGISTRY_PASSWORD }}
      
      - name: Extract metadata (frontend)
        id: meta-frontend
        uses: docker/metadata-action@v4
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_REPO_FRONTEND }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
      
      - name: Extract metadata (backend)
        id: meta-backend
        uses: docker/metadata-action@v4
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_REPO_BACKEND }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
      
      - name: Build and push frontend
        uses: docker/build-push-action@v4
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Build and push backend
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Scan images with Trivy
        run: |
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_REPO_FRONTEND }}:latest
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_REPO_BACKEND }}:latest
          trivy image ${{ env.REGISTRY }}/${{ env.IMAGE_REPO_FRONTEND }}:latest || true
          trivy image ${{ env.REGISTRY }}/${{ env.IMAGE_REPO_BACKEND }}:latest || true

  # Stage 5: Deploy to Staging
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build-containers
    if: github.ref == 'refs/heads/develop'
    environment:
      name: staging
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.30.0'
      
      - name: Configure kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG_STAGING }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
      
      - name: Create namespace
        run: |
          kubectl create namespace atonixcorp-staging --dry-run=client -o yaml | kubectl apply -f -
      
      - name: Deploy backend
        run: |
          kubectl -n atonixcorp-staging set image deployment/backend \
            backend=${{ env.REGISTRY }}/${{ env.IMAGE_REPO_BACKEND }}:develop \
            || kubectl -n atonixcorp-staging apply -f k8s/backend-deployment.yaml
      
      - name: Deploy frontend
        run: |
          kubectl -n atonixcorp-staging set image deployment/frontend \
            frontend=${{ env.REGISTRY }}/${{ env.IMAGE_REPO_FRONTEND }}:develop \
            || kubectl -n atonixcorp-staging apply -f k8s/frontend-deployment.yaml
      
      - name: Wait for rollout
        run: |
          kubectl -n atonixcorp-staging rollout status deployment/backend --timeout=5m
          kubectl -n atonixcorp-staging rollout status deployment/frontend --timeout=5m

  # Stage 6: Integration Tests
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: github.ref == 'refs/heads/develop'
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install -r backend/requirements.txt
          pip install pytest pytest-asyncio requests
      
      - name: Run integration tests
        env:
          API_URL: ${{ secrets.STAGING_API_URL }}
          API_KEY: ${{ secrets.STAGING_API_KEY }}
        run: |
          cd backend
          pytest tests/integration/ -v -s || true
      
      - name: Run smoke tests
        env:
          API_URL: ${{ secrets.STAGING_API_URL }}
        run: |
          python -m pytest tests/smoke/ -v || true

  # Stage 7: Promote to Production
  promote-production:
    name: Promote to Production
    runs-on: ubuntu-latest
    needs: [unit-tests-backend, unit-tests-frontend, security-scan, build-containers]
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.30.0'
      
      - name: Configure kubeconfig (Production)
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG_PRODUCTION }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
      
      - name: Create namespace
        run: |
          kubectl create namespace atonixcorp-production --dry-run=client -o yaml | kubectl apply -f -
      
      - name: Deploy backend to production
        run: |
          kubectl -n atonixcorp-production set image deployment/backend \
            backend=${{ env.REGISTRY }}/${{ env.IMAGE_REPO_BACKEND }}:main \
            || kubectl -n atonixcorp-production apply -f k8s/backend-deployment.yaml
      
      - name: Deploy frontend to production
        run: |
          kubectl -n atonixcorp-production set image deployment/frontend \
            frontend=${{ env.REGISTRY }}/${{ env.IMAGE_REPO_FRONTEND }}:main \
            || kubectl -n atonixcorp-production apply -f k8s/frontend-deployment.yaml
      
      - name: Wait for rollout
        run: |
          kubectl -n atonixcorp-production rollout status deployment/backend --timeout=10m
          kubectl -n atonixcorp-production rollout status deployment/frontend --timeout=10m
      
      - name: Verify deployment
        run: |
          kubectl -n atonixcorp-production get deployments
          kubectl -n atonixcorp-production get pods
          kubectl -n atonixcorp-production get services

  # Notification
  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [lint-and-format, unit-tests-backend, unit-tests-frontend, security-scan, build-containers]
    if: always()
    steps:
      - name: Send Slack notification
        if: failure()
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK }}
          payload: |
            {
              "text": "AtonixCorp CI/CD Pipeline Failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Pipeline Status*: ‚ùå Failed\n*Repository*: ${{ github.repository }}\n*Branch*: ${{ github.ref }}\n*Commit*: ${{ github.sha }}"
                  }
                }
              ]
            }
