version: '3.8'
services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_DB: atonixcorp_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - postgres-data:/var/lib/postgresql/data

  rabbitmq:
    image: rabbitmq:3-management
    ports:
      - "5672:5672"   # AMQP
      - "15672:15672" # Management UI
    environment:
      RABBITMQ_DEFAULT_USER: user
      RABBITMQ_DEFAULT_PASS: password

  redis:
    image: redis:7

  ruby_service:
    image: atonixcorp-ruby-service:1.0.0
    
    expose:
      - "49789"

      ruby-service:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "4567:4567"
    environment:
      - RACK_ENV=development
      - PORT=4567
      - DATABASE_URL=postgres://ruby_user:ruby_password@postgres:5432/atonixcorp_ruby
      - REDIS_URL=redis://redis:6379/0
      - SECRET_KEY_BASE=development-secret-key
      - SIDEKIQ_USERNAME=admin
      - SIDEKIQ_PASSWORD=password
      - LOG_LEVEL=debug
      - ENABLE_SIDEKIQ_SCHEDULER=true
    depends_on:
      - postgres
      - redis
    volumes:
      - .:/app
      - /app/tmp
      - /app/log
    networks:
      - atonixcorp

  sidekiq:
    build:
      context: .
      dockerfile: Dockerfile
    command: bundle exec sidekiq
    environment:
      - RACK_ENV=development
      - DATABASE_URL=postgres://ruby_user:ruby_password@postgres:5432/atonixcorp_ruby
      - REDIS_URL=redis://redis:6379/0
      - SECRET_KEY_BASE=development-secret-key
      - LOG_LEVEL=debug
      - ENABLE_SIDEKIQ_SCHEDULER=true
    depends_on:
      - postgres
      - redis
    volumes:
      - .:/app
      - /app/tmp
      - /app/log
    networks:
      - atonixcorp

  backend:
    image: atonixcorp-backend:1.0.0
    environment:
      DATABASE_URL: "postgresql://postgres:postgres@postgres:5432/atonixcorp"
      REDIS_URL: "redis://redis:6379/0"
      RUBY_SERVICE_HOST: "ruby_service"
      RUBY_SERVICE_PORT: "49789"
      RABBITMQ_URL: "amqp://user:password@rabbitmq:5672/"
    depends_on:
      - postgres
      - redis
      - ruby_service
      - rabbitmq
      - frontend
    ports:
      - "8000:8000"
    restart: always

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    environment:
    # The frontend nginx serves on container port 80; map it to host 3000 (host 3000 is in use)
    ports:
      - "3000:80"
    depends_on:
      - backend
    restart: always

  nginx:
    image: nginx:stable
    volumes:
      - ./docker/nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      - "8080:80"
    depends_on:
      - frontend
      - backend
      - ruby_service
      - sidekiq
      - redis
      - rabbitmq
    restart: always

    spark-master:
    image: apache/spark:3.4.1
    environment:
      - SPARK_MASTER_WEBUI_PORT=8080
    ports:
      - "7077:7077"
      - "8090:8080"
    networks:
      - atonixcorp-platform_atonix-network
    restart: unless-stopped

  spark-worker:
    image: apache/spark:3.4.1
    environment:
      - SPARK_WORKER_WEBUI_PORT=8081
      - SPARK_MASTER=spark://spark-master:7077
    depends_on:
      - spark-master
    ports:
      - "8091:8081"
    networks:
      - atonixcorp-platform_atonix-network
    restart: unless-stopped

  zookeeper:
    image: zookeeper:3.8
    container_name: zookeeper
    environment:
      ZOO_MY_ID: 1
      ZOO_SERVERS: server.1=zookeeper:2888:3888
    ports:
      - "2181:2181"
    networks:
      - atonixcorp-platform_atonix-network
    restart: unless-stopped

  apache-proxy:
    image: httpd:2.4
    volumes:
      - ./apache-spark.conf:/usr/local/apache2/conf/httpd.conf:ro
    depends_on:
      - spark-master
    ports:
      - "8088:80"
    networks:
      - atonixcorp-platform_atonix-network
    restart: unless-stopped

networks:
  atonixcorp-platform_atonix-network:
    external: true


volumes:
  postgres_data:
  redis_data:
  rabbitmq_data:
  backend_data:
  ruby_service_data:


networks:
  atonixcorp:
    driver: bridge
