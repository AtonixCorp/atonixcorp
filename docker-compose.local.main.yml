version: "3.8"

networks:
  atonixcorp_net:
    external: true

volumes:
  postgres_data:
  redis_data:
  rabbitmq_data:
  backend_data:
  ruby_service_data:
  sidekiq_data:
  frontend_data:
  app_media:
  app_logs:
  static_volume:
  media_volume:
  prometheus_data:
  grafana_data:
  elasticsearch_data:

services:
  postgres:
    container_name: postgres
    image: postgres:15
    environment:
      POSTGRES_DB: atonixcorp_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - atonixcorp_net
    restart: unless-stopped

  redis:
    image: redis:7
    container_name: redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - atonixcorp_net
    restart: unless-stopped

  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: password
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - atonixcorp_net
    restart: unless-stopped

  ruby_service:
    image: ghcr.io/atonixcorp/atonixcorp-ruby-service:1.0.0
    container_name: ruby_service
    environment:
      RACK_ENV: production
      PORT: 3000
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/atonixcorp_db
      REDIS_URL: redis://redis:6379/0
      SECRET_KEY_BASE: development-secret-key
      LOG_LEVEL: info
      ENABLE_SIDEKIQ_SCHEDULER: "true"
    expose:
      - "3000"
    volumes:
      - ruby_service_data:/app/data
    networks:
      - atonixcorp_net
    restart: unless-stopped

  sidekiq:
    image: ghcr.io/atonixcorp/atonixcorp-ruby-service:1.0.0
    container_name: sidekiq
    command: bundle exec sidekiq -r ./app.rb
    environment:
      RACK_ENV: production
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/atonixcorp_db
      REDIS_URL: redis://redis:6379/0
      SECRET_KEY_BASE: development-secret-key
      LOG_LEVEL: info
      ENABLE_SIDEKIQ_SCHEDULER: "true"
    ports:
      - "3000:3000"
    volumes:
      - sidekiq_data:/app/data
    networks:
      - atonixcorp_net
    restart: unless-stopped

  backend:
    image: ghcr.io/atonixcorp/atonixcorp-backend:1.0.0
    container_name: atonixcorp_backend
    environment:
      ENVIRONMENT: production
      DEBUG: "False"
      SECRET_KEY: ${SECRET_KEY}
      ALLOWED_HOSTS: atonixcorp.org,www.atonixcorp.org,localhost:3001,127.0.0.1:3001,0.0.0.0:3001
      USE_HTTPS: "False"
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: ${REDIS_URL}
      EMAIL_HOST: ${EMAIL_HOST}
      EMAIL_PORT: ${EMAIL_PORT}
      EMAIL_USE_TLS: "True"
      DEFAULT_FROM_EMAIL: noreply@atonixcorp.org
      OTEL_ENABLED: "True"
      OTEL_SERVICE_NAME: atonixcorp-backend
      PROMETHEUS_METRICS_PORT: 8001
    ports:
      - "8000:8000"
    volumes:
      - app_media:/app/media
      - app_logs:/app/logs
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://127.0.0.1:8000/health/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    networks:
      - atonixcorp_net
    depends_on:
      - postgres
      - redis
      - ruby_service
      - rabbitmq
      # frontend does not need to be a dependency of backend (avoids circular depends_on)

  frontend:
    image: ghcr.io/atonixcorp/atonixcorp-frontend:1.0.0
    container_name: atonixcorp_frontend
    environment:
      REACT_APP_API_URL: http://localhost:8000/api
      REACT_APP_ENVIRONMENT: development
      CHOKIDAR_USEPOLLING: "true"
      GENERATE_SOURCEMAP: "true"
      REACT_APP_FRONTEND_URL: http://localhost:3001
      REACT_APP_RUBY_URL: http://ruby_service:3000
      REACT_APP_GITHUB_AUTH_URL: http://localhost:8000/api/auth/github/
      REACT_APP_GOOGLE_AUTH_URL: http://localhost:8000/api/auth/google/
      REACT_APP_GITLAB_AUTH_URL: http://localhost:8000/api/auth/gitlab/
      REACT_APP_LINKEDIN_AUTH_URL: http://localhost:8000/api/auth/linkedin/
    ports:
      - "3001:80"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    depends_on:
      - backend
      - postgres
      - ruby_service
      - sidekiq
      - redis
      - rabbitmq
    volumes:
      - frontend_data:/usr/share/nginx/html
    networks:
      - atonixcorp_net
    stdin_open: true
    tty: true
    restart: unless-stopped

  nginx:
    image: nginx:stable
    container_name: atonixcorp_nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - static_volume:/var/www/static
      - media_volume:/var/www/media
    depends_on:
      - backend
      - frontend
    networks:
      - atonixcorp_net
    profiles:
      - production
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  # MailHog (Development Email Server) - Optional
  mailhog:
    image: mailhog/mailhog:v1.0.1
    container_name: atonixcorp_mailhog
    ports:
      - "25:25"
      - "8025:8025"
    networks:
      - atonixcorp_net
    profiles:
      - email
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:8025 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Spark-related services (added from user's snippet)
  spark-master:
    image: apache/spark:3.4.1
    container_name: spark-master
    environment:
      SPARK_MASTER_WEBUI_PORT: 8080
    ports:
      - "7077:7077"
      - "8090:8080"
    networks:
      - atonixcorp_net
    restart: unless-stopped
    user: root
    command:
      [
        "bash",
        "-lc",
        "apt-get update -y >/dev/null && apt-get install -y rsync >/dev/null && exec /opt/spark/sbin/start-master.sh -h 0.0.0.0",
      ]

  spark-worker:
    image: apache/spark:3.4.1
    container_name: spark-worker
    environment:
      SPARK_WORKER_WEBUI_PORT: 8081
      SPARK_MASTER: spark://spark-master:7077
    depends_on:
      - spark-master
    ports:
      - "8091:8081"
    networks:
      - atonixcorp_net
    restart: unless-stopped
    user: root
    command:
      [
        "bash",
        "-lc",
        "apt-get update -y >/dev/null && apt-get install -y rsync >/dev/null && exec /opt/spark/sbin/start-worker.sh spark://spark-master:7077",
      ]

  zookeeper:
    image: zookeeper:3.8
    container_name: zookeeper
    environment:
      ZOO_MY_ID: 1
      ZOO_SERVERS: server.1=zookeeper:2888:3888
    ports:
      - "2181:2181"
    networks:
      - atonixcorp_net
    restart: unless-stopped

  apache-proxy:
    image: httpd:2.4
    container_name: apache-proxy
    volumes:
      - ./docker/apache-spark.conf:/usr/local/apache2/conf/httpd.conf:ro
    depends_on:
      - spark-master
    ports:
      - "8088:80"
    networks:
      - atonixcorp_net
    restart: unless-stopped

  prometheus:
    image: prom/prometheus:latest
    container_name: atonixcorp_prometheus
    ports:
      - "9091:9090"
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--web.console.libraries=/etc/prometheus/console_libraries"
      - "--web.console.templates=/etc/prometheus/consoles"
      - "--storage.tsdb.retention.time=200h"
      - "--web.enable-lifecycle"
    networks:
      - atonixcorp_net
    restart: unless-stopped

  # Grafana for metrics visualization
  grafana:
    image: grafana/grafana:latest
    container_name: atonixcorp_grafana
    ports:
      - "3002:3000"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin123
      GF_USERS_ALLOW_SIGN_UP: "false"
    networks:
      - atonixcorp_net
    restart: unless-stopped
    depends_on:
      - prometheus

  # ELK Stack for centralized logging
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.8.0
    container_name: atonixcorp_elasticsearch
    environment:
      discovery.type: single-node
      ES_JAVA_OPTS: -Xms1g -Xmx1g
      xpack.security.enabled: "false"
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    ports:
      - "9200:9200"
    networks:
      - atonixcorp_net
    restart: unless-stopped

  logstash:
    image: docker.elastic.co/logstash/logstash:8.8.0
    container_name: atonixcorp_logstash
    volumes:
      - ./monitoring/logstash/pipeline:/usr/share/logstash/pipeline:ro
      - ./monitoring/logstash/config/logstash.yml:/usr/share/logstash/config/logstash.yml:ro
    ports:
      - "5044:5044"
    environment:
      LS_JAVA_OPTS: "-Xmx256m -Xms256m"
    networks:
      - atonixcorp_net
    depends_on:
      - elasticsearch
    restart: unless-stopped

  kibana:
    image: docker.elastic.co/kibana/kibana:8.8.0
    container_name: atonixcorp_kibana
    ports:
      - "5601:5601"
    environment:
      ELASTICSEARCH_HOSTS: http://elasticsearch:9200
    networks:
      - atonixcorp_net
    depends_on:
      - elasticsearch
    restart: unless-stopped

  # Application Performance Monitoring
  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: atonixcorp_jaeger
    ports:
      - "16686:16686"
      - "14268:14268"
    environment:
      COLLECTOR_OTLP_ENABLED: "true"
    networks:
      - atonixcorp_net
    restart: unless-stopped
